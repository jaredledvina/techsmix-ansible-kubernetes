---
- hosts: all
  gather_facts: false
  become: true
  become_method: su
  vars:
    bootstrap_packages:
      - audit
      - htop
      - sudo
      - tree
      - uboot-tools
    restart_nodes: false
  tasks:
    - name: Ensure SSH public key is configured
      authorized_key:
        user: "{{ ansible_user }}"
        state: present
        exclusive: true
        key: "{{ lookup('file', ansible_ssh_private_key_file) }}"

    - name: Ensure cluster is fully up to date
      pacman:
        update_cache: true
        upgrade: yes

    - name: Ensure rng-tools is installed
      pacman:
        name: rng-tools
        state: present

    - name: Ensure rngd is running and starts at boot
      service:
        name: rngd
        enabled: true
        state: started

    - name: Ensure haveged is uninstalled
      pacman:
        name: haveged
        state: absent

    - name: Ensure lvm2 is uninstalled
      pacman:
        name: lvm2
        state: absent

    - name: Ensure bootstrap packages are installed
      pacman:
        name: "{{ bootstrap_packages }}"

    - name: Ensure /boot/boot.txt is configured
      template:
        src: templates/boot_boot.txt.j2
        dest: /boot/boot.txt
        owner: root
        group: root
        mode: 0755
      register: boot_txt

    - name: Generate U-boot image
      command: ./mkscr
      args:
        chdir: /boot
      when: boot_txt is changed

    - name: Ensure auditd is running and starts at boot
      service:
        name: auditd
        enabled: true
        state: started

    - name: Restart the node
      reboot:
      when: restart_nodes
